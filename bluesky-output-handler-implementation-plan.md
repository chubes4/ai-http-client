# Bluesky Output Handler Implementation Plan

This document outlines the step-by-step instructions for implementing a new "Bluesky" output handler for the Data Machine plugin. This output handler will allow users to publish content generated by Data Machine modules directly to Bluesky Social.

**Goal:** Create a modular and robust Bluesky output handler with support for text and image posts.

**1.  File Creation and Class Definition:**

*   **File Path:** Create a new PHP file at `includes/output/class-data-machine-output-bluesky.php`.
*   **Class Name:** Define a class named `Data_Machine_Output_Bluesky` within this file.
*   **Interface Implementation:** Ensure the class implements the `Data_Machine_Output_Handler_Interface`. This interface will require implementing the `handle()` and `get_settings_fields()` methods.

```php
<?php

/**
 * Handles the 'Bluesky' output type.
 *
 * Posts content to a specified Bluesky account.
 *
 * @package    Data_Machine
 * @subpackage Data_Machine/includes/output
 */

class Data_Machine_Output_Bluesky implements Data_Machine_Output_Handler_Interface {

    /**
     * Service Locator instance.
     * @var Data_Machine_Service_Locator
     */
    private $locator;

    /**
     * Constructor.
     * @param Data_Machine_Service_Locator $locator Service Locator instance.
     */
    public function __construct(Data_Machine_Service_Locator $locator) {
        $this->locator = $locator;
    }

    /**
     * Handles publishing the AI output to Bluesky.
     *
     * @param string $ai_output_string The finalized string from the AI.
     * @param array $module_job_config Configuration specific to this output job.
     * @param int|null $user_id The ID of the user whose Bluesky account should be used.
     * @param array $input_metadata Metadata from the original input source.
     * @return array|WP_Error Result array on success, WP_Error on failure.
     */
    public function handle( string $ai_output_string, array $module_job_config, ?int $user_id, array $input_metadata ): array|WP_Error {
        // Implementation will go here
    }

    /**
     * Defines the settings fields specific to the Bluesky output handler.
     *
     * @param array $current_config Current configuration values for this handler (optional).
     * @return array An array defining the settings fields.
     */
    public function get_settings_fields(array $current_config = []): array {
        // Implementation will go here
    }

    /**
     * Sanitizes the settings specific to this output handler.
     *
     * @param array $raw_settings Raw settings input.
     * @return array Sanitized settings array.
     */
    public function sanitize_settings(array $raw_settings): array {
        $sanitized = [];
        // Implementation will go here
        return $sanitized;
    }

    /**
     * Returns the user-friendly label for this output handler.
     *
     * @return string The label.
     */
    public static function get_label(): string {
        return __( 'Bluesky', 'data-machine' );
    }
}
```

**2.  Dependencies and Constructor:**

*   **Service Locator:** Inject `Data_Machine_Service_Locator` in the constructor to access shared services like the logger.
*   **Logger:** Use `$this->locator->get('logger')` to access the `Data_Machine_Logger` instance for logging errors, warnings, and debug information.

**3.  Settings Fields (`get_settings_fields()`):**

*   Implement the `get_settings_fields()` method to define the configuration fields for the Bluesky output handler.
*   **Fields:**
    *   `bluesky_handle`: Text input for the Bluesky handle (required).
    *   `bluesky_password`: Password input for the Bluesky password (required). **Ensure this field is handled securely using the `Data_Machine_Encryption_Helper` class and the plugin's encryption system.**
    *   `bluesky_char_limit`: Number input for character limit (optional, default to 300).
    *   `bluesky_include_source`: Checkbox to include source link (optional, default to true).
    *   `bluesky_enable_images`: Checkbox to enable image posting (optional, default to true).
*   **Field Structure:** Follow the array structure used in existing output handlers (e.g., `class-data-machine-output-twitter.php`) for defining settings fields ( `type`, `label`, `description`, `default`, `required`, etc.).

```php
    public function get_settings_fields(array $current_config = []): array {
        return [
            'bluesky_handle' => [
                'type' => 'text',
                'label' => __('Bluesky Handle', 'data-machine'),
                'description' => __('Your Bluesky handle (username or email).', 'data-machine'),
                'required' => true,
                'default' => '',
            ],
            'bluesky_password' => [
                'type' => 'password',
                'label' => __('Bluesky Password', 'data-machine'),
                'description' => __('Your Bluesky account password.', 'data-machine'),
                'required' => true,
                'default' => '',
            ],
            'bluesky_char_limit' => [
                'type' => 'number',
                'label' => __('Character Limit', 'data-machine'),
                'description' => __('Maximum characters per post. Leave blank for default (300).', 'data-machine'),
                'default' => 300,
                'attributes' => ['min' => 10, 'max' => 3000] // Bluesky limit is 300 graphemes, ~3000 chars
            ],
            'bluesky_include_source' => [
                'type' => 'checkbox',
                'label' => __('Include Source Link', 'data-machine'),
                'default' => true,
                'description' => __('Append the original source link to the Bluesky post if available?', 'data-machine')
            ],
            'bluesky_enable_images' => [
                'type' => 'checkbox',
                'label' => __('Enable Image Posting', 'data-machine'),
                'default' => true,
                'description' => __('Allow posting images to Bluesky if available in input metadata?', 'data-machine')
            ],
        ];
    }
```

**4.  Sanitize Settings (`sanitize_settings()`):**

*   Implement the `sanitize_settings()` method to sanitize and validate user input from the settings fields.
*   **Sanitization:** Use WordPress sanitization functions like `sanitize_text_field()`, `absint()`, and `wp_kses_post()` as needed.
*   **Validation:**  Validate character limits and other relevant settings.

```php
    public function sanitize_settings(array $raw_settings): array {
        $sanitized = [];
        $sanitized['bluesky_handle'] = sanitize_text_field($raw_settings['bluesky_handle'] ?? '');
        // Use Data_Machine_Encryption_Helper to encrypt the password before saving
        $encryption_helper = $this->locator->get('encryption_helper'); /* @var Data_Machine_Encryption_Helper $encryption_helper */
        $raw_password = $raw_settings['bluesky_password'] ?? '';
        $sanitized['bluesky_password'] = $encryption_helper->encrypt($raw_password);
        $sanitized['bluesky_char_limit'] = isset($raw_settings['bluesky_char_limit']) ? absint($raw_settings['bluesky_char_limit']) : 300;
        if ($sanitized['bluesky_char_limit'] > 3000 || $sanitized['bluesky_char_limit'] < 10) {
            $sanitized['bluesky_char_limit'] = 300; // Default to 300 if out of bounds
        }
        $sanitized['bluesky_include_source'] = !empty($raw_settings['bluesky_include_source']);
        $sanitized['bluesky_enable_images'] = !empty($raw_settings['bluesky_enable_images']);
        return $sanitized;
    }
```

**5.  Handle Method (`handle()`):**

*   This is the core method where the actual Bluesky posting logic will be implemented.
*   **Steps:**
    *   **Get Configuration:** Retrieve the output handler configuration from `$module_job_config['output_config']['bluesky']` and sanitized settings.
    *   **Authentication:**
    *   Use `com.atproto.server.createSession` endpoint to obtain an access token.
    *   Retrieve the encrypted `bluesky_password` from settings and **decrypt it using `Data_Machine_Encryption_Helper` before using it to authenticate with the Bluesky API.**
    *   Use `bluesky_handle` and the decrypted `bluesky_password` for authentication.
    *   Handle potential authentication errors (e.g., invalid credentials).
        *   Store the access token (consider transient storage).
    *   **Prepare Post Content:**
        *   Parse AI output using `Data_Machine_AI_Response_Parser`.
        *   Format the post text, considering character limits and "include source link" setting.
        *   Implement facet parsing for mentions and links (initially basic, can be enhanced later).
    *   **Image Handling (if enabled in settings and image URL is available in `$input_metadata`):**
        *   Download the image from `input_metadata['image_source_url']`.
        *   Upload the image to Bluesky using `com.atproto.repo.uploadBlob`.
        *   Construct the `embed` object for `app.bsky.embed.images` including the blob data, alt text, and aspect ratio (if available).
    *   **Create Post Record:**
        *   Construct the `record` object for `app.bsky.feed.post` with `text`, `createdAt`, and `embed` (if applicable).
        *   Use `com.atproto.repo.createRecord` endpoint to create the post.
        *   **Endpoint URL:** `PDS_URL + "/xrpc/com.atproto.repo.createRecord"`
        *   **Request Body:** JSON payload with `repo`, `collection: "app.bsky.feed.post"`, and the `record` object.
        *   **Headers:** Include `Authorization: Bearer YOUR_ACCESS_TOKEN` and `Content-Type: application/json`.
    *   **Handle API Responses:**
        *   Check for successful responses (e.g., HTTP 200 or 201).
        *   Parse the response JSON to extract the post URI and CID.
        *   Handle API errors and WP_Error responses, logging details using `Data_Machine_Logger`.
    *   **Return Result:** Return a success array with relevant information (post URL, ID, message) or a `WP_Error` object on failure.

**6.  Code Modularity and Reusability:**

*   **Follow Existing Patterns:**  Carefully examine `class-data-machine-output-twitter.php` and `class-data-machine-output-publish_remote.php` to understand how they handle API requests, error handling, and data formatting.  Aim for consistency in code style and structure.
*   **Helper Functions:** Consider creating helper functions within the class for tasks like:
    *   `get_bluesky_access_token()`: Handles authentication and token retrieval/storage.
    *   `upload_bluesky_image()`:  Handles image uploading to Bluesky.
    *   `format_bluesky_post_text()`:  Handles text formatting and facet parsing.
*   **Error Handling:** Implement robust error handling throughout the `handle()` method, logging errors and returning informative `WP_Error` objects.

**7.  Integration with Data Machine:**

*   **Handler Registry:** Ensure the new `Data_Machine_Output_Bluesky` class is correctly registered with the Data Machine plugin's output handler registry so it becomes available as an output option in modules.  This likely involves modifying the `Data_Machine_Handler_Registry` or a similar class.
*   **Settings Integration:** Verify that the settings fields defined in `get_settings_fields()` are correctly displayed in the plugin's admin panel and that settings are saved and retrieved properly.

**8.  Testing:**

*   **Unit Testing (Optional but Recommended):** If possible, consider adding unit tests for the `Data_Machine_Output_Bluesky` class to test individual methods (especially `handle()` and `sanitize_settings()`) in isolation.
*   **Manual Testing:** Thoroughly test the output handler by:
    *   Creating a Data Machine module with the Bluesky output handler.
    *   Configuring Bluesky settings with valid credentials.
    *   Running the module and verifying successful posting to Bluesky with text-only content.
    *   Testing with image posting enabled and verifying successful image embeds.
    *   Testing error scenarios (invalid credentials, API errors, network issues).
    *   Testing character limits and source link inclusion.

**9.  Documentation:**

*   Create documentation for users on how to set up and use the Bluesky output handler.
*   Include instructions on obtaining Bluesky credentials (handle/password).
*   Explain the available settings and their impact on Bluesky posts.
*   Document any limitations or known issues.

This detailed step-by-step plan should provide a clear roadmap for developing the Bluesky output handler. Remember to prioritize modularity and follow the existing code patterns within the Data Machine plugin for a clean and maintainable implementation.